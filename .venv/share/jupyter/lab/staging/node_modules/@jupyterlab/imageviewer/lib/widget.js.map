{"version":3,"file":"widget.js","sourceRoot":"","sources":["../../../../imageviewer/src/widget.ts"],"names":[],"mappings":"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","sourcesContent":["// Copyright (c) Jupyter Development Team.\n// Distributed under the terms of the Modified BSD License.\n\nimport { PathExt } from '@jupyterlab/coreutils';\n\nimport {\n  ABCWidgetFactory,\n  DocumentRegistry,\n  IDocumentWidget,\n  DocumentWidget\n} from '@jupyterlab/docregistry';\n\nimport { PromiseDelegate } from '@phosphor/coreutils';\n\nimport { Message } from '@phosphor/messaging';\n\nimport { Widget } from '@phosphor/widgets';\n\n/**\n * The class name added to a imageviewer.\n */\nconst IMAGE_CLASS = 'jp-ImageViewer';\n\n/**\n * A widget for images.\n */\nexport class ImageViewer extends Widget {\n  /**\n   * Construct a new image widget.\n   */\n  constructor(context: DocumentRegistry.Context) {\n    super();\n    this.context = context;\n    this.node.tabIndex = -1;\n    this.addClass(IMAGE_CLASS);\n\n    this._img = document.createElement('img');\n    this.node.appendChild(this._img);\n\n    this._onTitleChanged();\n    context.pathChanged.connect(this._onTitleChanged, this);\n\n    context.ready.then(() => {\n      if (this.isDisposed) {\n        return;\n      }\n      const contents = context.contentsModel;\n      this._format = contents.format === 'base64' ? ';base64' : '';\n      this._mimeType = contents.mimetype;\n      this._render();\n      context.model.contentChanged.connect(this.update, this);\n      context.fileChanged.connect(this.update, this);\n      this._ready.resolve(void 0);\n    });\n  }\n\n  /**\n   * The image widget's context.\n   */\n  readonly context: DocumentRegistry.Context;\n\n  /**\n   * A promise that resolves when the image viewer is ready.\n   */\n  get ready(): Promise<void> {\n    return this._ready.promise;\n  }\n\n  /**\n   * The scale factor for the image.\n   */\n  get scale(): number {\n    return this._scale;\n  }\n  set scale(value: number) {\n    if (value === this._scale) {\n      return;\n    }\n    this._scale = value;\n    this._updateStyle();\n  }\n\n  /**\n   * The color inversion of the image.\n   */\n  get colorinversion(): number {\n    return this._colorinversion;\n  }\n  set colorinversion(value: number) {\n    if (value === this._colorinversion) {\n      return;\n    }\n    this._colorinversion = value;\n    this._updateStyle();\n  }\n\n  /**\n   * Reset rotation and flip transformations.\n   */\n  resetRotationFlip(): void {\n    this._matrix = [1, 0, 0, 1];\n    this._updateStyle();\n  }\n\n  /**\n   * Rotate the image counter-clockwise (left).\n   */\n  rotateCounterclockwise(): void {\n    this._matrix = Private.prod(\n      this._matrix,\n      Private.rotateCounterclockwiseMatrix\n    );\n    this._updateStyle();\n  }\n\n  /**\n   * Rotate the image clockwise (right).\n   */\n  rotateClockwise(): void {\n    this._matrix = Private.prod(this._matrix, Private.rotateClockwiseMatrix);\n    this._updateStyle();\n  }\n\n  /**\n   * Flip the image horizontally.\n   */\n  flipHorizontal(): void {\n    this._matrix = Private.prod(this._matrix, Private.flipHMatrix);\n    this._updateStyle();\n  }\n\n  /**\n   * Flip the image vertically.\n   */\n  flipVertical(): void {\n    this._matrix = Private.prod(this._matrix, Private.flipVMatrix);\n    this._updateStyle();\n  }\n\n  /**\n   * Handle `update-request` messages for the widget.\n   */\n  protected onUpdateRequest(msg: Message): void {\n    if (this.isDisposed || !this.context.isReady) {\n      return;\n    }\n    this._render();\n  }\n\n  /**\n   * Handle `'activate-request'` messages.\n   */\n  protected onActivateRequest(msg: Message): void {\n    this.node.focus();\n  }\n\n  /**\n   * Handle a change to the title.\n   */\n  private _onTitleChanged(): void {\n    this.title.label = PathExt.basename(this.context.localPath);\n  }\n\n  /**\n   * Render the widget content.\n   */\n  private _render(): void {\n    let context = this.context;\n    let cm = context.contentsModel;\n    if (!cm) {\n      return;\n    }\n    let content = context.model.toString();\n    this._img.src = `data:${this._mimeType}${this._format},${content}`;\n  }\n\n  /**\n   * Update the image CSS style, including the transform and filter.\n   */\n  private _updateStyle(): void {\n    let [a, b, c, d] = this._matrix;\n    let [tX, tY] = Private.prodVec(this._matrix, [1, 1]);\n    let transform = `matrix(${a}, ${b}, ${c}, ${d}, 0, 0) translate(${\n      tX < 0 ? -100 : 0\n    }%, ${tY < 0 ? -100 : 0}%) `;\n    this._img.style.transform = `scale(${this._scale}) ${transform}`;\n    this._img.style.filter = `invert(${this._colorinversion})`;\n  }\n\n  private _format: string;\n  private _mimeType: string;\n  private _scale = 1;\n  private _matrix = [1, 0, 0, 1];\n  private _colorinversion = 0;\n  private _ready = new PromiseDelegate<void>();\n  private _img: HTMLImageElement;\n}\n\n/**\n * A widget factory for images.\n */\nexport class ImageViewerFactory extends ABCWidgetFactory<\n  IDocumentWidget<ImageViewer>\n> {\n  /**\n   * Create a new widget given a context.\n   */\n  protected createNewWidget(\n    context: DocumentRegistry.IContext<DocumentRegistry.IModel>\n  ): IDocumentWidget<ImageViewer> {\n    const content = new ImageViewer(context);\n    const widget = new DocumentWidget({ content, context });\n    return widget;\n  }\n}\n\n/**\n * A namespace for image widget private data.\n */\nnamespace Private {\n  /**\n   * Multiply 2x2 matrices.\n   */\n  export function prod(\n    [a11, a12, a21, a22]: number[],\n    [b11, b12, b21, b22]: number[]\n  ): number[] {\n    return [\n      a11 * b11 + a12 * b21,\n      a11 * b12 + a12 * b22,\n      a21 * b11 + a22 * b21,\n      a21 * b12 + a22 * b22\n    ];\n  }\n\n  /**\n   * Multiply a 2x2 matrix and a 2x1 vector.\n   */\n  export function prodVec(\n    [a11, a12, a21, a22]: number[],\n    [b1, b2]: number[]\n  ): number[] {\n    return [a11 * b1 + a12 * b2, a21 * b1 + a22 * b2];\n  }\n\n  /**\n   * Clockwise rotation transformation matrix.\n   */\n  export const rotateClockwiseMatrix = [0, 1, -1, 0];\n\n  /**\n   * Counter-clockwise rotation transformation matrix.\n   */\n  export const rotateCounterclockwiseMatrix = [0, -1, 1, 0];\n\n  /**\n   * Horizontal flip transformation matrix.\n   */\n  export const flipHMatrix = [-1, 0, 0, 1];\n\n  /**\n   * Vertical flip transformation matrix.\n   */\n  export const flipVMatrix = [1, 0, 0, -1];\n}\n"]}